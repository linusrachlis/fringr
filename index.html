<!DOCTYPE html>
<html>

<head>
    <title>Fringr</title>
    <meta charset=utf8>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js"></script>
</head>

<body>
    <div>
        <textarea id=my-list placeholder="Paste play URLs here, one per line" rows=10 cols=100></textarea>
        <button id=refresh-button>Refresh</button>
    </div>
    <div>
        <p id=feed-urls-message style="display:none">
            Add these URLs as calendar feeds to show this on your own calendar:
        </p>
        <div id=feed-urls></div>
    </div>

    <div id=calendar></div>

    <script>
        $(function () {
            $('#calendar').fullCalendar({
                defaultView: 'agendaWeek',
            });

            const $feedUrlsContainer = $('#feed-urls');
            const $feedUrlsMessage = $('#feed-urls-message');

            $feedUrlsContainer.on('focus', 'input', function () {
                this.select();
            });
            $feedUrlsContainer.on('click', 'button.copy', function () {
                const urlToCopy = $(this).parent().children('input').val();
                copyToClipboard(urlToCopy);
            });

            const calendar = $('#calendar').fullCalendar('getCalendar');

            const colours = [
                {
                    color: '#ff0000',
                    textColor: 'black',
                },
                {
                    color: '#00ff00',
                    textColor: 'black',
                },
                {
                    color: '#0000ff',
                    textColor: 'white',
                },
                {
                    color: '#ffff00',
                    textColor: 'black',
                },
                {
                    color: '#00ffff',
                    textColor: 'black',
                },
                {
                    color: '#ff00ff',
                    textColor: 'black',
                },
                // TODO add more colours
            ];

            $('#refresh-button').click(function () {
                let colourIndex = 0;
                const urlsValue = $('#my-list').val();
                if (urlsValue.length == 0) return;
                const urls = urlsValue.split(/\s+/);

                calendar.removeEventSources();
                $feedUrlsContainer.empty();
                $feedUrlsMessage.toggle(urls.length > 0);

                for (let i = 0; i < urls.length; i++) {
                    const playUrlEncoded = encodeURIComponent(urls[i]);
                    const eventSourceUrl = 'event_source.php?play_url=' + playUrlEncoded;
                    const colour = colours[colourIndex];
                    colourIndex = (colourIndex + 1) % colours.length;
                    const eventSource = Object.assign({}, colour, {url: eventSourceUrl});
                    calendar.addEventSource(eventSource);

                    const feedUrl =
                        'https://linus.rachlis.net/fringr/event_source.php?play_url=' +
                        playUrlEncoded + '&format=ical';
                    const $feedUrlInput = $('<input type=text size=100 readonly>').val(feedUrl);
                    const $feedUrlInputContainer = $('<div>')
                        .append($feedUrlInput)
                        .append('<button class=copy>Copy</button>');
                    $feedUrlsContainer.append($feedUrlInputContainer);
                }
            });

            const copyToClipboard = str => {
              const el = document.createElement('textarea');
              el.value = str;
              el.setAttribute('readonly', '');
              el.style.position = 'absolute';
              el.style.left = '-9999px';
              document.body.appendChild(el);
              el.select();
              document.execCommand('copy');
              document.body.removeChild(el);
            };
        });

    </script>
</body>

</html>
